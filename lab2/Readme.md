# 实验二

### 实验题目：利用MPI进行蒙特卡洛模拟

>实验环境：
>
>操作系统：Windows 10家庭中文版
>
>编译器：gcc 8.1.0
>
>IDE：Visual Studio Community 2019 16.4.5
>
>CPU：Intel i5-7300HQ 2.50GHz (4核)
>
>内存：8.00GB

### 算法设计与分析

串行算法模拟单条道路的交通状态只需要按照题目给定的条件模拟即可。而利用MPI进行并行模拟则需要把车辆均匀分配给每个进程，每个周期结束后，除最后一个进程，都向后一个进程发送本进程负责的最后一辆车的位置，用于模拟下一个进程的第一辆车。在一个周期结束后，还需要进行同步，防止各个进程处于不同的周期而产生错误。当模拟结束后，根进程收集各个进程的车辆信息输出即可。

### 核心代码

每个进程模拟一个周期车辆运动的核心循环如下所示，只要按照题目要求模拟即可

```c++
for (int i = 0; i < cnt; i++) {
	int previous = i == 0 ? limit : last_d[i - 1];//前一辆车的坐标
	if (previous - last_d[i] - 1 > v[i]) {//是零号车或者前车距离大于当前速度则加速
		if (v[i] != V_MAX) v[i]++;//并且还没有超过最大速度
	}
	else v[i] = previous - last_d[i] - 1;//否则速大小度变为与前车车距
	if (1.0 * rand() / RAND_MAX < P && v[i]>0)//随机以P的概率减速
		v[i]--;
	d[i] = last_d[i] + v[i];//确定了速度v后向前移动v的距离
}
```

### 实验结果

下面的实验结果为最高限速v_max=100,减速概率p=0.2的情况下得到的：

n=40，周期数=100时的结果如下图所示：

<img src="E:\STUDY\Parallel Computing\lab2\1.jpg" style="zoom:67%;" />

可以看出所有车辆都已经启动了，但是还没有进入稳定前进的状态，后面的车速度还较慢，前面的车速度较快。

运行时间如下表所示单位为秒：

下表中规模用车辆数/周期数的格式表示

| 规模\进程数 | 1         | 2         | 4        | 8         |
| ----------- | --------- | --------- | -------- | --------- |
| 100000/2000 | 14.848211 | 7.594971  | 4.090609 | 16.568016 |
| 500000/500  | 18.258942 | 9.751564  | 6.445628 | 8.106385  |
| 1000000/300 | 22.813311 | 11.031940 | 6.634676 | 8.134683  |

加速比如下表所示

| 规模\进程数 | 1    | 2     | 4     | 8     |
| ----------- | ---- | ----- | ----- | ----- |
| 100000/2000 | 1    | 1.955 | 3.630 | 0.896 |
| 500000/500  | 1    | 1.872 | 2.833 | 2.252 |
| 1000000/300 | 1    | 2.068 | 3.438 | 2.804 |

### 分析与总结

从结果上看，由于受到物理核心数的限制，当进程数在4及以下时增加进程数能有效提高运行效率，但是增加到8线程后不仅不能加速，反而将因为进程间通讯与同步等开销的增加而降低运行速度。这启示我们并行程序的设计并不是并行度越高越好，还要综合考虑通信、同步和创建进程等的代价。

